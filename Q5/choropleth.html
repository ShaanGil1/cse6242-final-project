<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <!-- add title -->
    
    <!-- import required libraries here -->
    <script src="../lib/d3.v5.min.js"></script>
	<script src="../lib/topojson.v2.min.js"></script>
	<script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    
    <style>
        /* define CSS rules here */
    
    </style>

    <title></title>
</head>


<body>
    <!-- Add heading for the visualization -->
    
    
    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->

    <select id="gameDropdown"></select> 

    <!-- append visualization svg to this div-->
    <div id="choropleth"></div>
    <!-- <div id="tooltip"></div> -->

    <script>
    
        // enter code to define margin and dimensions for svg
        var margin = {top: 80,right: 40,bottom: 100,left: 40}
        var width = 1200 - margin.left - margin.right
        var height = 900 - margin.top - margin.bottom;
        
        // enter code to create svg
        var svg=d3
        .select("div#choropleth")
        .append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height",height + margin.top + margin.right)
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        // enter code to create color scale
        var colorsch = d3.schemeReds[6]

        
        
        // enter code to define tooltip
        
        
        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"
        // var projection = 
        // var path =

        var projection = 
        d3.geoNaturalEarth1()
        // .scale(200)
        // .translate([width/2,height/2]);
        

        var path = d3.geoPath()
        .projection(projection);


        // define any other global variables 



        Promise.all([
            // enter code to read files
            d3.json("world_countries.json"),
            d3.csv("ratings-by-country.csv")
            
        ]).then(
            // enter code to call ready() with required arguments
            function(files) {
            ready(null, files[0], files[1]);
        }
                    
            
        );
        
        // this function should be called once the data from files have been read
        // world: topojson from world_countries.json
        // gameData: data from ratings-by-country.csv
        
        function ready(error, world, gameData) {
            // enter code to extract all unique games from gameData
            uniqueGames = new Set()
            gameRating = {}

            gameData.forEach(function(d){
                uniqueGames.add(d.Game)
                if (d.Game in gameRating) {
                    gameRating[d.Game][d.Country] = {
                        "Average Rating": parseFloat(d["Average Rating"]),
                        "Number of Users": parseInt(d["Number of Users"])
                    }
                    
                } else {
                    gameRating[d.Game] = {}
                    gameRating[d.Game][d.Country] = {
                        "Average Rating": parseFloat(d["Average Rating"]),
                        "Number of Users": parseInt(d["Number of Users"])
                    }
                }

            });
            console.log(gameRating)
            games = Array.from(uniqueGames);
            games.sort()

            // enter code to append the game options to the dropdown
            var dropDown = d3.select("select#gameDropdown").attr('transform', 'translate(40,40)');
            // var dropDown = svg.append("select")//
            // .attr("id", "”gameDropdown”");

            var options = dropDown.selectAll("option")
            .data(games)
            .enter()
            .append("option");

            options.text(function(d) {
            return d;
            })
            .attr("value", function(d) {
            return d;
            });
            
            // event listener for the dropdown. Update choropleth and legend when selection changes. Call createMapAndLegend() with required arguments.
            dropDown.on('change',onchange)
            function onchange() {
                selectValue = d3.select('select').property('value')
                console.log(selectValue)
                d3.selectAll(".country")
	  .remove();
                d3.selectAll(".tooltip")
                .remove();
                createMapAndLegend(world, gameRating[selectValue], selectValue)
            };
            // create Choropleth with default option. Call createMapAndLegend() with required arguments. 
            createMapAndLegend(world, gameRating[games[0]], games[0])
        }

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){ 
            var quantile = d3.scaleQuantile()
            .domain(Object.values(gameData).map((value) => (value["Average Rating"]) )) // pass the whole dataset to a scaleQuantile’s domain
            .range(colorsch.slice(0, 4))
            .range(["#fdcc8a","#fc8d59","#e34a33", "#d7301f"])

            var map = svg.append("g")
                .attr("id", "countries")
                .attr("class", "country")
                .selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("fill", function (d) {
                    var val = gameData[d.properties.name]
                    if (val) {
                        return quantile(gameData[d.properties.name]["Average Rating"])
                    } else {
                        return "gray"
                    }
                }
                )
                .attr("stroke", "#000")
                .attr("d", path)

                var toolTip = d3.tip()
                .attr("id","tooltip")
                // .class("class","tip")
                .html(function(d) { 
                    console.log(d)
                    if (gameData[d.properties.name]) {
                        return `Country: ${d.properties.name}<br> Game: ${selectedGame} <br> Avg Rating ${gameData[d.properties.name]["Average Rating"]} <br> Number of users: ${gameData[d.properties.name]["Number of Users"]}`; 
                    } else {
                        return `Country: ${d.properties.name}<br> Game: ${selectedGame} <br> Avg Rating ${"N/A"} <br> Number of users: ${"N/A"}`; 
                    }
                })
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px")
                map.call(toolTip)
                // var toolTip = d3.select("div#choropleth")
                //     .append("div")
                
                map.on('mouseover', toolTip.show)
                .on('mouseout', toolTip.hide);

                var legen = svg.append("g")
                .attr("id", "legend").attr("class", "legendQuant").attr("transform", "translate(1000,20)");
            
                var legend = d3.legendColor()
                .labelFormat(d3.format(".2f"))
                .titleWidth(100)
                .scale(quantile);

                svg.select(".legendQuant")
                .call(legend);

            
        }
    </script>

</body>

</html>